# Проект: Node.js + PostgreSQL в Docker

## Описание

Данный проект представляет собой веб-приложение на Node.js с использованием базы данных PostgreSQL. Приложение запускается в Docker-контейнерах и поддерживает автоматические миграции базы данных.

## Основной функционал

- Запуск сервера на Node.js.
- Работа с PostgreSQL для хранения данных.
- API для получения и добавления пользователей.
- Конфигурация приложения через переменные окружения.
- Выполнение автоматических миграций базы данных при запуске.

## Требования

- Docker и Docker Compose должны быть установлены на вашем устройстве.
- Node.js и npm для локального запуска (опционально).

## Установка и запуск

1. Склонируйте репозиторий:

   ```bash
   git clone <URL репозитория>
   cd <директория проекта>
## Запуск приложения

Запустите приложение с помощью Docker Compose:

```bash
docker-compose up --build
## Запуск приложения

Приложение будет доступно по адресу: [http://localhost:3000](http://localhost:3000)

## API Эндпоинты

- **GET /**

  Возвращает сообщение о том, что сервер работает.

- **GET /users**

  Возвращает список пользователей из базы данных.

- **POST /users**

  Добавляет нового пользователя в базу данных.
## Структура проекта

- **src/migration.js**: Скрипт автоматических миграций базы данных.
- **src/server.js**: Основной файл сервера.
- **docker-compose.yml**: Настройки Docker Compose для запуска приложения и базы данных.
- **Dockerfile**: Описание сборки Docker-образа для приложения.
## Конфигурация

Приложение использует переменные окружения, задаваемые в `docker-compose.yml`:

- **PORT**: Порт для запуска приложения (по умолчанию 3000).
- **DATABASE_URL**: URL для подключения к базе данных PostgreSQL.
- **POSTGRES_DB**, **POSTGRES_USER**, **POSTGRES_PASSWORD**: Настройки базы данных.
## Файлы проекта

### Dockerfile

```dockerfile
# Условие 2: Используем легковесный базовый образ
FROM node:20-alpine

# Условие 8: Создаем непривилегированного пользователя
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser

# Условие 5: Указываем рабочую директорию для приложения
WORKDIR /app

# Копируем и устанавливаем зависимости
COPY --chown=appuser:appgroup package.json package-lock.json ./
RUN npm install --omit=dev \
    && npm cache clean --force  # Условие 9: Очищаем кеш после установки зависимостей

# Условие 4: Статика должна быть внешним volume
COPY --chown=appuser:appgroup ./src ./src

# Проверяем наличие файлов
RUN ls /app/src

# Открываем порт для приложения
EXPOSE 3000

# Условие 7: Выполняем автоматические миграции перед запуском
CMD ["sh", "-c", "node ./src/migration.js && node ./src/server.js"]
### docker-compose.yml

```yaml
version: "3.8"

services:
  db:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: riejxx
      POSTGRES_PASSWORD: Aa160282**
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U riejxx -d mydb"]
      interval: 10s
      retries: 5

  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - DATABASE_URL=postgres://riejxx:Aa160282**@db:5432/mydb
    volumes:
      - .:/app
      - /app/node_modules
    depends_on:
      db:
        condition: service_healthy

volumes:
  db_data:
## Выполнение условий лабораторной работы

1. **Образ должен быть легковесным**

   Используется базовый образ `node:20-alpine`, минимизирующий размер.

2. **Использовать базовые легковесные образы - alpine**

   Все сервисы (Node.js, PostgreSQL) используют версии образов на базе `alpine`.

3. **Вся конфигурация приложения должна быть через переменные окружения**

   Переменные окружения передаются в `docker-compose.yml`.

4. **Статика (зависимости) должна быть внешним томом volume**

   Внешний том используется для хранения зависимостей и данных базы.

5. **Создать файл docker-compose для старта и сборки**

   Файл `docker-compose.yml` присутствует и обеспечивает сборку.

6. **Использование базы данных**

   Приложение работает с PostgreSQL, запускаемым в отдельном контейнере.

7. **Выполнение автоматических миграций**

   Перед запуском сервера выполняется скрипт миграций базы данных.

8. **Контейнер запускается от непривилегированного пользователя**

   В `Dockerfile` создаётся и используется непривилегированный пользователь.

9. **Очистка кеша**

   После установки зависимостей выполняется очистка кеша `npm`.
## Авторы

- **Имя**: Иваницкий Илья
- **Имя**: Лавренова Юлия
